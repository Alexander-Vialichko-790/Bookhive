{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="container mt-4">

  <!-- üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è + –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
  <div class="row mb-5">
    <div class="col-md-1">
      {% if book.images.count > 1 %}
        <div class="d-flex flex-column gap-2">
          {% for img in book.images.all %}
            <a href="#slide{{ forloop.counter0 }}" data-bs-target="#bookCarousel" data-bs-slide-to="{{ forloop.counter0 }}">
              <img src="{{ img.image.url }}" class="img-thumbnail" style="height: 60px; object-fit: cover;">
            </a>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <div class="col-md-3">
      {% if book.images.all %}
        <div id="bookCarousel" class="carousel slide" data-bs-ride="carousel">
          <div class="carousel-inner">
            {% for img in book.images.all %}
              <div class="carousel-item {% if forloop.first %}active{% endif %}" id="slide{{ forloop.counter0 }}">
                <img src="{{ img.image.url }}" class="d-block w-100 rounded shadow-sm" alt="{{ book.title }}" style="height: 400px; object-fit: contain;">
              </div>
            {% endfor %}
          </div>
        </div>
      {% else %}
        <img src="{{ book.image.url }}" class="img-fluid rounded shadow-sm" alt="{{ book.title }}" style="height: 400px; object-fit: contain;">
      {% endif %}
    </div>

    <div class="col-md-8">
      <h2 class="mb-2">{{ book.title }}</h2>

      <!-- üìä –û—Ü–µ–Ω–∫–∞ –∏ –æ—Ç–∑—ã–≤—ã -->
      <div class="mb-3">
        {% if avg_rating %}
          <span class="text-warning"><i class="bi bi-star-fill"></i></span>
          <strong>{{ avg_rating|floatformat:1 }}</strong>
          <small class="text-muted">({{ reviews.count }} –æ—Ü–µ–Ω{% if reviews.count|add:"0"|divisibleby:10 or reviews.count|add:"0"|divisibleby:11 %}–æ–∫{% elif reviews.count|add:"0"|stringformat:"s"|slice:"-1" == "1" %}–∫–∞{% elif reviews.count|add:"0"|stringformat:"s"|slice:"-1" in "234" %}–∫–∏{% else %}–æ–∫{% endif %})</small>
          <a href="#reviews" class="ms-2 fw-semibold text-primary">{{ reviews.count }} —Ä–µ—Ü–µ–Ω–∑–∏{% if reviews.count|add:"0"|divisibleby:10 or reviews.count|add:"0"|divisibleby:11 %}–π{% elif reviews.count|add:"0"|stringformat:"s"|slice:"-1" == "1" %}—è{% elif reviews.count|add:"0"|stringformat:"s"|slice:"-1" in "234" %}–∏{% else %}–π{% endif %}</a>
        {% else %}
          <span class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫</span>
        {% endif %}
      </div>

      <p><strong>–ê–≤—Ç–æ—Ä:</strong> {{ book.author.name }}</p>
      <p><strong>–ñ–∞–Ω—Ä:</strong> {{ book.genre.name }}</p>
      <p><strong>–ò–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ:</strong> {{ book.publisher.name }}</p>
      <p><strong>–ì–æ–¥:</strong> {{ book.year }}</p>

      {% if book.discount %}
        <p>
          <del class="text-muted">{{ book.price|floatformat:2 }} ‚ÇΩ</del>
          <span class="fw-bold text-danger ms-2">{{ book.discounted_price|floatformat:2 }} ‚ÇΩ</span>
          <span class="badge bg-danger ms-2">-{{ book.discount }}%</span>
        </p>
      {% else %}
        <p><strong>–¶–µ–Ω–∞:</strong> <span class="fw-bold text-success">{{ book.price|floatformat:2 }} ‚ÇΩ</span></p>
      {% endif %}

      {% if book.cashback %}
        <p>üí∞ <small>–ö—ç—à–±—ç–∫: {{ book.cashback }} ‚ÇΩ –±—É–¥–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏</small></p>
      {% endif %}

      <p>
        {% if book.status == 'in_stock' %}
          ‚úÖ <span class="text-success">–í –Ω–∞–ª–∏—á–∏–∏</span>
        {% elif book.status == 'preorder' %}
          üî¥ <span class="text-warning">–ü–æ–¥ –∑–∞–∫–∞–∑</span>
        {% else %}
          ‚ùå <span class="text-danger">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
        {% endif %}
      </p>

      <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ book.description }}</p>

      <a href="{% url 'add_to_cart' book.pk %}" class="btn btn-outline-primary mt-3">
        üõí –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
      </a>
    </div>
  </div>

  <!-- üåü –û—Ç–∑—ã–≤—ã -->
  <hr id="reviews">
  <h4 class="mb-4">–û—Ç–∑—ã–≤—ã</h4>

  {% if reviews %}
    {% for review in reviews %}
      <div class="card mb-3 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div class="d-flex align-items-center mb-2">
              <img src="{% if review.user.profile.photo %}{{ review.user.profile.photo.url }}{% else %}{% static 'img/default-avatar.png' %}{% endif %}"
              alt="–ê–≤–∞—Ç–∞—Ä"
                   class="rounded-circle me-2"
                   style="width: 40px; height: 40px; object-fit: cover;">
              <h5 class="mb-0">{{ review.user.username }}</h5>
            </div>            
            <small class="text-muted">{{ review.created_at|date:"d.m.Y H:i" }}</small>
          </div>
          <div class="mb-2">
            {% for i in "12345" %}
              {% if review.rating|add:0 >= forloop.counter %}
                <i class="bi bi-star-fill text-warning"></i>
              {% else %}
                <i class="bi bi-star text-secondary"></i>
              {% endif %}
            {% endfor %}
          </div>
          <p class="mb-2">{{ review.text }}</p>

          {% if review.user == user %}
          <div class="d-flex gap-2">
            <a href="{% url 'edit_review' review.pk %}" class="btn btn-sm btn-outline-secondary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
            <a href="{% url 'delete_review' review.pk %}" class="btn btn-sm btn-outline-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</a>
          </div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p class="text-muted">–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
  {% endif %}

  <!-- ‚úçÔ∏è –§–æ—Ä–º–∞ –æ—Ç–∑—ã–≤–∞ -->
  <hr>
  {% if user.is_authenticated %}
    <div class="mt-4">
      <h5>–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h5>
      <form method="post" class="mt-3">
        {% csrf_token %}
        <div class="mb-3">
          {{ form.text.label_tag }}
          {{ form.text|add_class:"form-control" }}
          {% for error in form.text.errors %}
            <div class="form-text text-danger">{{ error }}</div>
          {% endfor %}
        </div>
        <div class="mb-3">
          {{ form.rating.label_tag }}
          {{ form.rating|add_class:"form-select w-auto" }}
          {% for error in form.rating.errors %}
            <div class="form-text text-danger">{{ error }}</div>
          {% endfor %}
        </div>
        <button type="submit" class="btn btn-success">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>
    </div>
  {% else %}
    <p class="mt-3">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤.</p>
  {% endif %}

</div>
{% endblock %}
